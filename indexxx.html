<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Help Desk (Admin Dashboard)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
        /* Base Styles */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .comment-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .comment-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .comment-scrollbar::-webkit-scrollbar-track { background-color: #f1f5f9; }
        .view { display: none !important; }
        .view.active { display: block !important; animation: fadeIn 0.3s ease-out; }
        #auth-view.view.active { display: flex !important; }
        #admin-dashboard-view.view.active { display: flex !important; height: 100vh; overflow: hidden; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .animated-gradient { background: linear-gradient(-45deg, #f0fdfa, #ccfbf1, #a7f3d0, #0d9488); background-size: 400% 400%; animation: gradientBG 15s ease infinite; }
        @keyframes fadeInUp { from { opacity: 0; transform: translate3d(0, 30px, 0); } to { opacity: 1; transform: translate3d(0, 0, 0); } }
        .animate-fadeInUp { opacity: 1; animation: fadeInUp 0.6s ease-out; }
        
        button, input, select, textarea, a { transition: all 0.2s ease-in-out; }
        button:hover, a:hover { transform: translateY(-1px); }
        button:active, a:active { transform: translateY(0); }
        input:focus, select:focus, textarea:focus, button:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.3); border-color: #0d9488; }
        
        .ticket-tab-button { border-bottom: 3px solid transparent; transform: translateY(1px); }
        .ticket-tab-button.active { border-color: #0d9488; color: #0d9488; font-weight: 600; }
        .ticket-tab-panel { display: none; }
        .ticket-tab-panel.active { display: block; }
        .toast { position: fixed; top: 20px; right: 20px; background-color: #ef4444; color: white; padding: 12px 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; animation: toast-in 0.3s ease-out; }
        @keyframes toast-in { from { opacity: 0; transform: translate3d(100%, 0, 0); } to { opacity: 1; transform: translate3d(0, 0, 0); } }
        .toast.fade-out { animation: toast-out 0.5s ease-in forwards; }
        @keyframes toast-out { from { opacity: 1; transform: translate3d(0, 0, 0); } to { opacity: 0; transform: translate3d(100%, 0, 0); } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; animation: fadeIn 0.2s ease-out forwards; }
        .modal-content { background-color: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px; transform: scale(0.95); animation: fadeInUp 0.2s ease-out forwards; }
        #comment-toolbar { border-top-left-radius: 8px; border-top-right-radius: 8px; border-color: #d1d5db !important; background: #f9fafb; }
        #comment-editor { border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; border-color: #d1d5db !important; background: white; color: #111827; font-family: 'Inter', sans-serif; font-size: 14px; }
        .ql-editor { min-height: 120px; }
        .ql-snow .ql-editor.static-content { min-height: 0; border: none; line-height: 1.5; padding-top: 0; padding-bottom: 0; }
        .ql-editor.ql-blank::before { color: #9ca3af; font-style: normal; font-family: 'Inter', sans-serif; }
        
        .avatar-group { display: flex; -space-x-2: -0.5rem; }
        .avatar-group img { border: 2px solid white; }

        /* Admin Dashboard Theme Overrides */
        .admin-sidebar { background-color: #f9fafb; border-right: 1px solid #e5e7eb; }
        .admin-header { background-color: white; border-bottom: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .admin-main-card { border: 1px solid #d1d5db; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-radius: 12px; }

        .dashboard-btn-active {
             background-color: #e0f2f7; /* Teal 50 */
             border: 2px solid #0d9488; /* Teal 700 */
             font-weight: 700;
             color: #0d9488;
             border-radius: 6px;
        }
        .dashboard-btn {
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s;
        }
        .dashboard-btn:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen text-gray-800">
    <svg width="0" height="0" class="hidden">
        <!-- Icons reused from previous code -->
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="icon-ticket-logo"><path d="M14 6l5 5V20a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h7.5L14 6z"></path><path d="M9 18h6"></path><path d="M9 14h6"></path><path d="M9 10h3"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="icon-bell"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="icon-plus"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="icon-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="icon-inbox"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="icon-ticket"><path d="M14 6l5 5V20a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h7.5L14 6z"></path><path d="M9 18h6"></path><path d="M9 14h6"></path><path d="M9 10h3"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="icon-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="icon-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="icon-chat"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="icon-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></symbol>
    </svg>
    
    <div id="auth-view" class="view active min-h-screen animated-gradient flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-6 animate-fadeInUp" style="animation-delay: 0s;">
                <svg class="h-12 w-12 text-teal-700 mx-auto"><use href="#icon-ticket-logo"></use></svg>
                <h1 class="text-3xl font-bold text-gray-900 mt-2">Workflow Help Desk</h1>
            </div>
            <div id="login-view" class="auth-card view active animate-fadeInUp" style="animation-delay: 0.1s;">
                <div class="bg-white rounded-xl shadow-2xl border border-gray-200 p-8 space-y-6">
                    <h2 class="text-2xl font-bold text-center text-gray-900">Welcome Back</h2>
                    <div id="login-error" class="hidden p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="login-email" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" required>
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="login-password" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" required>
                        </div>
                        <div class="text-sm text-right"><a href="#" id="show-forgot-form" class="font-medium text-teal-600 hover:underline">Forgot password?</a></div>
                        <button type="submit" class="w-full flex items-center justify-center h-10 px-4 py-2 bg-teal-600 text-white rounded-md text-sm font-medium hover:bg-teal-700 shadow-sm">Log In</button>
                    </form>
                    <p class="text-sm text-center text-gray-600">Don't have an account? <a href="#" id="show-signup-form" class="font-medium text-teal-600 hover:underline">Sign up</a></p>
                </div>
                <div class="bg-white rounded-xl shadow-2xl border border-gray-200 p-8 mt-6 animate-fadeInUp" style="animation-delay: 0.2s;">
                    <h3 class="text-lg font-semibold text-center text-gray-800 mb-4">Easy Demo Logins</h3>
                    <div class="space-y-3">
                        <button data-email="bob@admin.com" data-password="password123" class="demo-login-button w-full h-10 px-4 py-2 bg-gray-800 text-white rounded-md text-sm font-medium hover:bg-gray-900 shadow-sm ring-2 ring-offset-2 ring-gray-800">Log in as Admin (Bob)</button>
                        <button data-email="charlie@tech.com" data-password="password123" class="demo-login-button w-full h-10 px-4 py-2 bg-gray-600 text-white rounded-md text-sm font-medium hover:bg-gray-700 shadow-sm">Log in as Tech Dept (Charlie)</button>
                        <button data-email="dana@billing.com" data-password="password123" class="demo-login-button w-full h-10 px-4 py-2 bg-gray-600 text-white rounded-md text-sm font-medium hover:bg-gray-700 shadow-sm">Log in as Billing Dept (Dana)</button>
                        <button data-email="alice@client.com" data-password="password123" class="demo-login-button w-full h-10 px-4 py-2 bg-gray-500 text-white rounded-md text-sm font-medium hover:bg-gray-600 shadow-sm">Log in as Client (Alice)</button>
                    </div>
                </div>
            </div>
             <div id="signup-view" class="auth-card view animate-fadeInUp">
                <div class="bg-white rounded-xl shadow-2xl border border-gray-200 p-8 space-y-6">
                    <h2 class="text-2xl font-bold text-center text-gray-900">Create an Account</h2>
                    <div id="signup-error" class="hidden p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
                    <form id="signup-form" class="space-y-4">
                        <div>
                            <label for="signup-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                            <input type="text" id="signup-name" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" required>
                        </div>
                        <div>
                            <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="signup-email" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" required>
                        </div>
                        <div>
                            <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="signup-password" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" required>
                        </div>
                        <button type="submit" class="w-full flex items-center justify-center h-10 px-4 py-2 bg-teal-600 text-white rounded-md text-sm font-medium hover:bg-teal-700 shadow-sm">Create Account</button>
                    </form>
                    <p class="text-sm text-center text-gray-600">Already have an account? <a href="#" id="show-login-form-from-signup" class="font-medium text-teal-600 hover:underline">Log in</a></p>
                </div>
            </div>
            <div id="forgot-password-view" class="auth-card view animate-fadeInUp">
                <div class="bg-white rounded-xl shadow-2xl border border-gray-200 p-8 space-y-6">
                    <h2 class="text-2xl font-bold text-center text-gray-900">Reset Password</h2>
                    <div id="forgot-success" class="hidden p-3 bg-green-100 text-green-700 rounded-md text-sm"></div>
                    <p class="text-sm text-gray-600 text-center">Enter your email and we'll send you instructions to reset your password. (This is a simulation).</p>
                    <form id="forgot-form" class="space-y-4">
                        <div>
                            <label for="forgot-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="forgot-email" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" required>
                        </div>
                        <button type="submit" class="w-full flex items-center justify-center h-10 px-4 py-2 bg-teal-600 text-white rounded-md text-sm font-medium hover:bg-teal-700 shadow-sm">Send Reset Link</button>
                    </form>
                    <p class="text-sm text-center text-gray-600">Remembered your password? <a href="#" id="show-login-form-from-forgot" class="font-medium text-teal-600 hover:underline">Log in</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN DASHBOARD VIEW (SKETCH BASED) -->
    <div id="admin-dashboard-view" class="view w-full bg-gray-100">
        <!-- Sidebar -->
        <div class="w-64 bg-white admin-sidebar flex flex-col h-full fixed left-0 top-0 z-20">
            <div class="p-4 border-b border-gray-200 flex items-center">
                <svg class="h-6 w-6 text-teal-600 mr-2"><use href="#icon-ticket-logo"></use></svg>
                <div class="text-xl font-bold text-teal-600">Admin</div>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button id="admin-nav-dashboard" class="w-full text-left px-4 py-2 rounded-md font-bold text-lg bg-teal-50 text-teal-800 shadow-sm">Dashboard</button>
                <button id="admin-nav-projects" class="w-full text-left px-4 py-2 font-medium text-lg hover:bg-gray-100 rounded-md text-gray-700">Projects</button>
                <button class="w-full text-left px-4 py-2 font-medium text-lg hover:bg-gray-100 rounded-md text-gray-400 cursor-not-allowed">User management</button>
                <button class="w-full text-left px-4 py-2 font-medium text-lg hover:bg-gray-100 rounded-md text-gray-400 cursor-not-allowed">settings</button>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 ml-64 flex flex-col h-full overflow-hidden">
            <!-- Top Bar -->
            <header class="h-16 admin-header flex items-center justify-between px-8 sticky top-0 z-10">
                <div class="font-bold text-xl text-gray-900">Admin Dashboard</div>
                <div class="flex items-center gap-6">
                    <span class="font-medium text-gray-600">Bob Johnson (Admin)</span>
                    <span class="font-medium cursor-pointer text-teal-600 hover:underline">Live Chat</span>
                    <button id="admin-logout" class="flex items-center font-medium text-gray-600 hover:text-red-600">
                        <svg class="h-5 w-5 mr-1"><use href="#icon-log-out"></use></svg> Logout
                    </button>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div class="p-6 md:p-8 overflow-y-auto flex-1">
                <div id="admin-status-buttons" class="flex flex-wrap gap-3 mb-6">
                    <!-- Buttons injected by renderAdminDashboard -->
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[450px]">
                    <!-- Chart Area -->
                    <div class="lg:col-span-2 admin-main-card bg-white p-4 flex flex-col">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Ticket Trends (Last 7 Days)</h3>
                        <div class="flex-1">
                            <canvas id="adminTicketChart"></canvas>
                        </div>
                    </div>

                    <!-- Feeds Area -->
                    <div class="lg:col-span-1 admin-main-card bg-white p-4 flex flex-col">
                        <h3 class="text-xl font-bold mb-4 text-center border-b pb-2 text-gray-800">All Over Feeds</h3>
                        <div id="admin-feed-list" class="flex-1 overflow-y-auto space-y-3 pr-2 comment-scrollbar">
                            <!-- Feed items will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- Bottom Panels (Updated with detail) -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                    <div class="admin-main-card bg-white p-4 flex flex-col justify-between">
                        <h4 class="font-bold text-lg mb-1 text-red-600">Takedown / Escalation</h4>
                        <p class="text-sm text-gray-600 flex-grow">
                            **Focus:** Currently **2 Delayed** tickets requiring immediate attention. Review high-priority issues flagged for legal or urgent action.
                        </p>
                        <button class="text-teal-600 hover:underline text-sm font-medium mt-2 text-left" onclick="app.showToast('Takedown View is a feature stub.', false)">View Detail &rarr;</button>
                    </div>
                    <div class="admin-main-card bg-white p-4 flex flex-col justify-between cursor-pointer hover:bg-gray-50 transition-colors" id="admin-btn-project-details">
                        <h4 class="font-bold text-lg mb-1 text-teal-600">Projects Details</h4>
                        <p class="text-sm text-gray-600 flex-grow">
                            **Total Projects:** ${MOCK_DATA.projects.length}. View all existing projects, check client external visibility, and create new ones.
                        </p>
                        <button class="text-teal-600 hover:underline text-sm font-medium mt-2 text-left" onclick="app.navigate('dashboard')">Go to Projects &rarr;</button>
                    </div>
                    <div class="admin-main-card bg-white p-4 flex flex-col justify-between">
                        <h4 class="font-bold text-lg mb-1 text-blue-600">Department Status</h4>
                        <p class="text-sm text-gray-600 flex-grow">
                            **Tech:** 2 Assigned. **Billing:** 0 Assigned. Quickly view which department carries the current workload.
                        </p>
                        <button class="text-teal-600 hover:underline text-sm font-medium mt-2 text-left" onclick="app.showToast('Department Status View is a feature stub.', false)">View Workload &rarr;</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- STANDARD APP VIEW -->
    <div id="main-app-view" class="view">
        <nav class="bg-white shadow-md w-full sticky top-0 z-50">
            <div class="max-w-[98%] mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center gap-4">
                        <svg class="h-6 w-6 text-teal-600"><use href="#icon-ticket-logo"></use></svg>
                        <h1 id="nav-title" class="text-xl font-bold text-teal-600">Workflow Help Desk</h1>
                    </div>
                    <div id="nav-right-side" class="flex items-center gap-4"></div>
                </div>
            </div>
        </nav>

        <main id="app-container" class="w-full bg-gray-50 min-h-[calc(100vh-64px)]">
            
            <div id="dashboard-view" class="app-view view h-full">
            </div>

            <!-- Other Views... -->
            <div id="new-project-view" class="app-view view max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
                <button id="cancel-new-project" class="flex items-center text-sm font-medium text-teal-600 hover:underline mb-4">
                    <svg class="h-4 w-4 mr-1"><use href="#icon-arrow-left"></use></svg>
                    Back to Projects
                </button>
                <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg border border-gray-200">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-900">Create a New Project</h2>
                    </div>
                    <form id="new-project-form" class="p-6 space-y-4">
                        <div>
                            <label for="new-project-name" class="block text-sm font-medium text-gray-700 mb-1">Project Name</label>
                            <input type="text" id="new-project-name" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="e.g., Q4 Marketing Website" required>
                        </div>
                        
                        <div>
                            <label for="new-project-type" class="block text-sm font-medium text-gray-700 mb-1">Project Type</label>
                            <select id="new-project-type" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" required>
                                <option value="External">External (Client Facing)</option>
                                <option value="Internal">Internal (Company Only)</option>
                            </select>
                        </div>

                        <div>
                            <label for="new-project-description" class="block text-sm font-medium text-gray-700 mb-1">Project Description</label>
                            <textarea id="new-project-description" rows="3" class="flex min-h-[80px] w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="A brief description of the project..."></textarea>
                        </div>
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" id="cancel-new-project-form" class="h-10 px-4 py-2 bg-gray-100 text-gray-900 rounded-md text-sm font-medium hover:bg-gray-200 shadow-sm">
                                Cancel
                            </button>
                            <button type="submit" class="flex items-center justify-center h-10 px-4 py-2 bg-teal-600 text-white rounded-md text-sm font-medium hover:bg-teal-700 shadow-sm">
                                Create Project
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="project-detail-view" class="app-view view max-w-[98%] mx-auto p-2 sm:p-4">
                <button id="back-to-projects" class="flex items-center text-sm font-medium text-teal-600 hover:underline mb-4">
                    <svg class="h-4 w-4 mr-1"><use href="#icon-arrow-left"></use></svg>
                    Back to All Projects
                </button>
                <div class="flex justify-between items-center mb-6">
                    <h2 id="project-detail-title" class="text-3xl font-bold text-gray-900">Project Title</h2>
                    <button id="show-new-ticket-form" class="flex items-center justify-center h-10 px-4 py-2 bg-teal-600 text-white rounded-md text-sm font-medium hover:bg-teal-700 focus:outline-none shadow-sm">
                        <svg class="h-5 w-5 mr-2 -ml-1"><use href="#icon-plus"></use></svg>
                        Create New Ticket
                    </button>
                </div>
                <div id="project-ticket-lists" class="space-y-8">
                    <!-- Dynamic content will be inserted here by renderProjectDetail -->
                </div>
            </div>

            <div id="ticket-detail-view" class="app-view view max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
                <button id="back-to-project-detail" class="flex items-center text-sm font-medium text-teal-600 hover:underline mb-4">
                    <svg class="h-4 w-4 mr-1"><use href="#icon-arrow-left"></use></svg>
                    Back to Project
                </button>
                <div id="ticket-detail-header" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-6"></div>
                <div id="ticket-detail-content" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-xl shadow-lg border border-gray-200">
                            <nav class="flex border-b border-gray-200" id="ticket-tab-nav"></nav>
                            <div id="ticket-tab-content" class="p-6"></div>
                        </div>
                    </div>
                    <div id="ticket-detail-sidebar" class="lg:col-span-1 space-y-6"></div>
                </div>
            </div>

            <div id="new-ticket-view" class="app-view view max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
                <button id="cancel-new-ticket" class="flex items-center text-sm font-medium text-teal-600 hover:underline mb-4">
                    <svg class="h-4 w-4 mr-1"><use href="#icon-arrow-left"></use></svg>
                    Back to Project
                </button>
                <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg border border-gray-200">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-900">Create a New Ticket</h2>
                    </div>
                    <form id="new-ticket-form" class="p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="new-ticket-name" class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                                <input type="text" id="new-ticket-name" class="flex h-10 w-full rounded-md border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-500 cursor-not-allowed" readonly>
                            </div>
                            <div>
                                <label for="new-ticket-email" class="block text-sm font-medium text-gray-700 mb-1">Your Email</label>
                                <input type="email" id="new-ticket-email" class="flex h-10 w-full rounded-md border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-500 cursor-not-allowed" readonly>
                            </div>
                        </div>
                        
                        <div id="new-ticket-project-wrapper" class="hidden">
                            <label for="new-ticket-project" class="block text-sm font-medium text-gray-700 mb-1">Project</label>
                            <input type="text" id="new-ticket-project-name" class="flex h-10 w-full rounded-md border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-500 cursor-not-allowed" readonly>
                        </div>
                        
                        <div>
                            <label for="new-ticket-priority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                            <select id="new-ticket-priority" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" required>
                                <option>Low</option>
                                <option>Medium</option>
                                <option>High</option>
                            </select>
                        </div>
                        <div>
                            <label for="new-ticket-subject" class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                            <input type="text" id="new-ticket-subject" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="e.g., Website is down" required>
                        </div>
                        <div>
                            <label for="new-ticket-due-date" class="block text-sm font-medium text-gray-700 mb-1">Due Date (Optional)</label>
                            <input type="date" id="new-ticket-due-date" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm">
                        </div>
                        <div>
                            <label for="new-ticket-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="new-ticket-description" rows="5" class="flex min-h-[80px] w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="Describe your issue in detail..." required></textarea>
                        </div>
                        <div id="internal-ticket-toggle" class="hidden">
                            <div class="flex items-center">
                                <input id="new-ticket-internal" type="checkbox" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                <label for="new-ticket-internal" class="ml-2 block text-sm text-gray-900">
                                    Mark as Internal Ticket (not visible to clients)
                                </label>
                            </div>
                        </div>
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" id="cancel-new-ticket-form" class="h-10 px-4 py-2 bg-gray-100 text-gray-900 rounded-md text-sm font-medium hover:bg-gray-200 shadow-sm">
                                Cancel
                            </button>
                            <button type="submit" class="flex items-center justify-center h-10 px-4 py-2 bg-teal-600 text-white rounded-md text-sm font-medium hover:bg-teal-700 shadow-sm">
                                Submit Ticket
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Insert Link Modal -->
    <div id="insert-link-modal" class="modal-overlay hidden">
        <!-- ... same modal content ... -->
         <div class="modal-content">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Insert Link</h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6"><use href="#icon-x"></use></svg>
                </button>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label for="modal-link-text" class="block text-sm font-medium text-gray-700 mb-1">Text to display</label>
                    <input type="text" id="modal-link-text" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm">
                </div>
                <div>
                    <label for="modal-link-url" class="block text-sm font-medium text-gray-700 mb-1">To what URL should this link go?</label>
                    <input type="url" id="modal-link-url" placeholder="https://example.com" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm">
                </div>
            </div>
            <div class="flex justify-end gap-3 p-4 border-t bg-gray-50 rounded-b-lg">
                <button id="modal-cancel-btn" type="button" class="h-10 px-4 py-2 bg-gray-100 text-gray-900 rounded-md text-sm font-medium hover:bg-gray-200">Cancel</button>
                <button id="modal-insert-btn" type="button" class="h-10 px-4 py-2 bg-teal-600 text-white rounded-md text-sm font-medium hover:bg-teal-700">Insert Link</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <script type="module">
        // --- FAKE DATABASE & MOCK DATA ---
        const MOCK_DATA = {
            users: [
                { id: 'u1', name: 'Alice Smith', email: 'alice@client.com', role: 'User', password: 'password123' },
                { id: 'u2', name: 'Bob Johnson (Admin)', email: 'bob@admin.com', role: 'Admin', password: 'password123' },
                { id: 'u3', name: 'User 3', email: 'user3@client.com', role: 'User', password: 'password123' },
                { id: 'd1', name: 'Charlie (Tech)', email: 'charlie@tech.com', role: 'Department', departmentId: 'dept1', password: 'password123' },
                { id: 'd2', name: 'Dana (Billing)', email: 'dana@billing.com', role: 'Department', departmentId: 'dept2', password: 'password123' },
            ],
            departments: [
                { id: 'dept1', name: 'Technical Support' },
                { id: 'dept2', name: 'Billing Department' },
            ],
            projects: [
                { id: 'p1', name: 'Main Website Redesign', type: 'External', description: "Overhaul of the corporate website with new branding." },
                { id: 'p2', name: 'Mobile App (iOS)', type: 'External', description: "Development of the new customer-facing iOS application." },
                { id: 'p3', name: 'Internal Tools', type: 'Internal', description: "Maintenance and updates for internal admin dashboards." },
            ],
            tickets: [
                {
                    id: 'T-1001',
                    subject: 'Website is down',
                    projectId: 'p1',
                    createdByUserId: 'u1',
                    type: 'External',
                    status: 'New',
                    priority: 'High',
                    description: 'Our main website is not loading. We are getting a 500 error.',
                    assignedToUserId: null,
                    createdAt: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(),
                    dueDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(),
                    resolution: null,
                    timeEntries: [],
                    comments: [
                        { userId: 'u1', text: '<p>This is urgent, please help!</p>', isHtml: true, timestamp: new Date(Date.now() - 1 * 59 * 60 * 1000).toISOString() }
                    ],
                    history: [
                        { userId: 'u1', userName: 'Alice Smith', action: 'created the ticket', timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString() },
                        { userId: 'u1', userName: 'Alice Smith', action: 'added a comment', timestamp: new Date(Date.now() - 1 * 59 * 60 * 1000).toISOString() }
                    ]
                },
                {
                    id: 'T-1002',
                    subject: 'Password reset failure',
                    projectId: 'p1',
                    createdByUserId: 'u1',
                    type: 'External',
                    status: 'Assigned',
                    priority: 'Medium',
                    description: 'I am trying to reset my password but I am not receiving the email.',
                    assignedToUserId: 'd1',
                    createdAt: new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString(),
                    dueDate: null,
                    resolution: null,
                    timeEntries: [],
                    comments: [
                        { userId: 'u1', text: '<p>I tried three times, nothing in spam.</p>', isHtml: true, timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString() },
                        { userId: 'u2', text: '<p>Assigned to Charlie.</p>', isHtml: true, timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString() }
                    ],
                    history: [
                        { userId: 'u1', userName: 'Alice Smith', action: 'created the ticket', timestamp: new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString() },
                        { userId: 'u1', userName: 'Alice Smith', action: 'added a comment', timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString() },
                        { userId: 'u2', userName: 'Bob Johnson (Admin)', action: 'assigned the ticket to Charlie (Tech)', timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString() },
                        { userId: 'u2', userName: 'Bob Johnson (Admin)', action: 'added a comment', timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString() }
                    ]
                },
                {
                    id: 'T-1003',
                    subject: 'Server upgrade planning',
                    projectId: 'p2',
                    createdByUserId: 'u2',
                    type: 'Internal',
                    status: 'In Progress',
                    priority: 'Low',
                    description: 'We need to plan the Q4 server migration for the mobile app backend.',
                    assignedToUserId: 'd1',
                    createdAt: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
                    dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                    resolution: null,
                    timeEntries: [
                        { userId: 'd1', hours: 2.5, date: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(), description: 'Initial cost analysis and research.' }
                    ],
                    comments: [
                        { userId: 'u2', text: '<p>Charlie, can you get a cost estimate?</p>', isHtml: true, timestamp: new Date(Date.now() - 20 * 60 * 60 * 1000).toISOString() },
                        { userId: 'd1', text: '<p>On it. I will have the estimate by EOD tomorrow. Logged 2.5 hours for initial research.</p>', isHtml: true, timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString() }
                    ],
                    history: [
                        { userId: 'u2', userName: 'Bob Johnson (Admin)', action: 'created the ticket', timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString() },
                        { userId: 'u2', userName: 'Bob Johnson (Admin)', action: 'assigned the ticket to Charlie (Tech)', timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString() },
                        { userId: 'd1', userName: 'Charlie (Tech)', action: 'changed status to In Progress', timestamp: new Date(Date.now() - 22 * 60 * 60 * 1000).toISOString() },
                        { userId: 'u2', userName: 'Bob Johnson (Admin)', action: 'added a comment', timestamp: new Date(Date.now() - 20 * 60 * 60 * 1000).toISOString() },
                        { userId: 'd1', userName: 'Charlie (Tech)', action: 'added a comment', timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString() },
                        { userId: 'd1', userName: 'Charlie (Tech)', action: 'logged 2.5 hours', timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString() }
                    ]
                },
                {
                    id: 'T-1004',
                    subject: 'Login Issues on Mobile',
                    projectId: 'p2',
                    createdByUserId: 'u3',
                    type: 'External',
                    status: 'New',
                    priority: 'Medium',
                    description: 'Can not login via iOS 15.',
                    assignedToUserId: null,
                    createdAt: new Date().toISOString(),
                    dueDate: null,
                    resolution: null,
                    timeEntries: [],
                    comments: [],
                    history: []
                }
            ],
            notifications: [
                { id: 'n1', userId: 'u2', text: 'New ticket T-1002 created by Alice Smith.', timestamp: new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString(), read: true },
                { id: 'n2', userId: 'd1', text: 'Ticket T-1002 (Password reset failure) assigned to you.', timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(), read: false },
                { id: 'n3', userId: 'u2', text: 'New ticket T-1001 created by Alice Smith.', timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(), read: false },
            ]
        };

        // --- APPLICATION STATE ---
        const app = {
            state: {
                currentUser: null,
                currentView: 'auth-login', 
                selectedProjectId: null,
                selectedTicketId: null,
                currentFilter: 'all',
                searchTerm: '',
                currentTheme: 'teal',
                activeTicketTab: 'conversation',
                users: MOCK_DATA.users,
                departments: MOCK_DATA.departments,
                projects: MOCK_DATA.projects,
                tickets: MOCK_DATA.tickets,
                notifications: MOCK_DATA.notifications,
                quillInstance: null,
                quillSelection: null,
                adminChartInstance: null // Store chart instance
            },
            
            // --- HELPER METHODS ---
            getUser(userId) { return this.state.users.find(u => u.id === userId) || { name: 'Unassigned' }; },
            getProject(projectId) { return this.state.projects.find(p => p.id === projectId) || { name: 'Unknown Project' }; },
            
            debounce(func, delay) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            },
            
            timeAgo(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                const seconds = Math.floor((new Date() - date) / 1000);
                if (seconds < 60) return "Just now";
                const intervals = { year: 31536000, month: 2592000, day: 86400, hour: 3600, minute: 60 };
                for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                    const interval = Math.floor(seconds / secondsInUnit);
                    if (interval >= 1) return `${interval} ${unit}${interval > 1 ? 's' : ''} ago`;
                }
                return "Just now";
            },
            
            formatDate(dateString) {
                if (!dateString) return 'N/A';
                return new Date(dateString).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
            },
            formatCreated(dateStr) {
                if (!dateStr) return 'N/A';
                const d = new Date(dateStr);
                const month = (d.getMonth() + 1).toString().padStart(2, '0');
                const day = d.getDate().toString().padStart(2, '0');
                let hour = d.getHours() % 12;
                if (hour === 0) hour = 12;
                const min = d.getMinutes().toString().padStart(2, '0');
                const ampm = d.getHours() >= 12 ? 'PM' : 'AM';
                return `${month}/${day} ${hour}:${min} ${ampm}`;
            },
            getStatusBadge(status) {
                const map = {
                    New: 'bg-blue-100 text-blue-800',
                    Assigned: 'bg-blue-100 text-blue-800',
                    'In Progress': 'bg-green-100 text-green-800',
                    'On Hold': 'bg-orange-100 text-orange-800',
                    Closed: 'bg-purple-100 text-purple-800',
                    Cancelled: 'bg-red-100 text-red-800'
                };
                const color = map[status] || 'bg-gray-100 text-gray-800';
                return `<span class="px-2 py-1 rounded-full text-xs font-semibold ${color}">${status}</span>`;
            },
            getPriorityBadge(priority) {
                const map = {
                    High: { color: 'bg-red-100 text-red-800', label: 'P1' },
                    Medium: { color: 'bg-orange-100 text-orange-800', label: 'P2' },
                    Low: { color: 'bg-green-100 text-green-800', label: 'P3' }
                };
                const p = map[priority] || { color: 'bg-gray-100 text-gray-600', label: '?' };
                return `<span class="px-2 py-1 rounded-full text-xs font-semibold ${p.color}">${p.label}</span>`;
            },
            
            getFilterTitle(filter) {
                const titles = { all: 'All Tickets', open: 'Open Tickets', unassigned: 'Unassigned Tickets', onhold: 'On Hold Tickets', progress: 'On Progress Tickets', closed: 'Closed Tickets', delayed: 'Delayed Tickets', sla: 'SLA Tickets' };
                return titles[filter] || 'Tickets';
            },

            // NEW: Get ticket counts for the admin dashboard buttons
            getTicketCounts() {
                const now = new Date();
                const counts = {
                    'All Tickets': this.state.tickets.length,
                    Open: 0,
                    'On Hold': 0,
                    'On progress': 0,
                    Closed: 0,
                    Delayed: 0,
                    SLA: 0,
                    Unassigned: 0
                };

                this.state.tickets.forEach(t => {
                    const isClosedOrCancelled = ['Closed', 'Cancelled'].includes(t.status);
                    const isOverdue = t.dueDate && new Date(t.dueDate) < now && !isClosedOrCancelled;

                    // Open (New or Assigned)
                    if (['New', 'Assigned'].includes(t.status)) counts.Open++;
                    
                    if (t.status === 'On Hold') counts['On Hold']++;
                    if (t.status === 'In Progress') counts['On progress']++;
                    if (isClosedOrCancelled) counts.Closed++;
                    if (!t.assignedToUserId) counts.Unassigned++;
                    
                    if (isOverdue) {
                        counts.Delayed++;
                        counts.SLA++; // Assuming SLA is essentially Delayed/Overdue for this demo
                    }
                });
                
                return counts;
            },

            filterTicket(ticket, filter) {
                const { status, assignedToUserId, dueDate } = ticket;
                const now = new Date();
                const overdue = dueDate && new Date(dueDate) < now && !['Closed', 'Cancelled'].includes(status);
                switch (filter) {
                    case 'all': return true;
                    case 'open': return ['New', 'Assigned'].includes(status);
                    case 'unassigned': return !assignedToUserId;
                    case 'onhold': return status === 'On Hold';
                    case 'progress': return status === 'In Progress';
                    case 'closed': return status === 'Closed' || status === 'Cancelled';
                    case 'delayed': return overdue;
                    case 'sla': return overdue;
                    default: return true;
                }
            },
            getProjectTickets() {
                let pts = this.state.tickets.filter(t => t.projectId === this.state.selectedProjectId);
                if (this.state.currentUser.role === 'User') {
                    pts = pts.filter(t => t.createdByUserId === this.state.currentUser.id);
                }
                return pts.filter(t => this.state.currentUser.role !== 'User' || t.type === 'External');
            },
            
            // ... UI rendering helpers (renderProjectTicketTable, showToast, etc) ...
            renderProjectTicketTable() {
                let tickets = this.getProjectTickets();
                tickets = tickets.filter(t => this.filterTicket(t, this.state.currentFilter));
                const searchLower = this.state.searchTerm.toLowerCase();
                tickets = tickets.filter(t =>
                    t.id.toLowerCase().includes(searchLower) ||
                    t.subject.toLowerCase().includes(searchLower) ||
                    this.getUser(t.createdByUserId).name.toLowerCase().includes(searchLower)
                );
                const tbody = document.getElementById('ticket-table-body');
                const noTicketsEl = document.getElementById('no-tickets');
                const tableTitle = document.getElementById('table-title');
                tableTitle.innerText = this.getFilterTitle(this.state.currentFilter);
                if (tickets.length === 0) {
                    noTicketsEl.classList.remove('hidden');
                    if (tbody) tbody.innerHTML = '';
                    return;
                }
                noTicketsEl.classList.add('hidden');
                if (tbody) {
                    tbody.innerHTML = tickets.map(t => {
                        const user = this.getUser(t.createdByUserId).name;
                        const assigned = t.assignedToUserId ? this.getUser(t.assignedToUserId).name : 'Unassigned';
                        const prio = this.getPriorityBadge(t.priority);
                        let statusBadge = this.getStatusBadge(t.status);
                        const isOverdue = t.dueDate && new Date(t.dueDate) < new Date() && !['Closed', 'Cancelled'].includes(t.status);
                        if (isOverdue) {
                            statusBadge += ' <span class="text-red-600 font-semibold ml-1">(Delayed)</span>';
                        }
                        const created = this.formatCreated(t.createdAt);
                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-2 text-sm text-gray-900">${t.id}</td>
                                <td class="px-4 py-2 text-sm text-gray-900">${t.subject}</td>
                                <td class="px-4 py-2 text-sm text-gray-900">${user}</td>
                                <td class="px-4 py-2 text-sm text-gray-900">${assigned}</td>
                                <td class="px-4 py-2 text-sm">${prio}</td>
                                <td class="px-4 py-2 text-sm">${statusBadge}</td>
                                <td class="px-4 py-2 text-sm text-gray-500">${created}</td>
                                <td class="px-4 py-2 text-sm">
                                    <div class="flex gap-2">
                                        <a href="#" data-ticket-id="${t.id}" class="text-teal-600 hover:underline">Details</a>
                                        <button data-delete-ticket="${t.id}" class="text-red-600 hover:underline">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            },

            // --- NEW: ADMIN DASHBOARD LOGIC ---
            renderAdminDashboard() {
                // 1. Get counts for buttons
                const counts = this.getTicketCounts();
                const statusButtons = document.getElementById('admin-status-buttons');

                const statusMap = {
                    'All Tickets': 'all',
                    'Open': 'open',
                    'On Hold': 'onhold',
                    'On progress': 'progress',
                    'Closed': 'closed',
                    'Delayed': 'delayed',
                    'SLA': 'sla',
                    'Unassigned': 'unassigned'
                };

                // Generate buttons with counts (Matching Theme)
                if (statusButtons) {
                    statusButtons.innerHTML = Object.entries(statusMap).map(([label, key]) => `
                        <button data-filter="${key}" class="dashboard-btn px-4 py-2 text-base">
                            <span class="font-semibold">${label}</span> 
                            <span class="ml-2 px-2 py-0.5 rounded-full ${key === 'all' ? 'bg-gray-100 text-gray-700' : key === 'closed' ? 'bg-purple-100 text-purple-700' : key === 'delayed' || key === 'sla' ? 'bg-red-100 text-red-700' : 'bg-teal-100 text-teal-700'}">${counts[label]}</span>
                        </button>
                    `).join('');
                }

                // 2. Render Feeds
                const feedsContainer = document.getElementById('admin-feed-list');
                const tickets = [...this.state.tickets].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                if (feedsContainer) {
                    feedsContainer.innerHTML = tickets.map(t => `
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 text-sm hover:bg-gray-100 transition-colors cursor-pointer" data-ticket-id="${t.id}" onclick="app.loadTicketDetail(this.dataset.ticketId)">
                            <div class="flex justify-between font-medium">
                                <span>${t.id} - ${t.subject}</span>
                                <span class="text-xs text-gray-500">${this.formatCreated(t.createdAt)}</span>
                            </div>
                            <div class="flex justify-between mt-1">
                                <span class="text-xs ${t.status === 'New' ? 'text-blue-600' : t.status === 'In Progress' ? 'text-green-600' : t.status === 'Assigned' ? 'text-orange-600' : 'text-gray-600'} font-semibold">${t.status}</span>
                                <span class="text-xs text-gray-500">Filed by: ${this.getUser(t.createdByUserId).name.split(' ')[0]}</span>
                            </div>
                        </div>
                    `).join('');
                }

                // 3. Render Chart
                this.renderAdminChart();
            },

            renderAdminChart() {
                const chartElement = document.getElementById('adminTicketChart');
                if (!chartElement) return;

                const ctx = chartElement.getContext('2d');
                
                // Destroy existing chart if it exists
                if (this.state.adminChartInstance) {
                    this.state.adminChartInstance.destroy();
                }

                // Generate Mock Trend Data (Last 7 Days)
                const labels = [];
                const datasets = {
                    all: [], open: [], onHold: [], progress: [], closed: [], delayed: [], unassigned: []
                };
                
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    labels.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
                    
                    const base = Math.floor(Math.random() * 3);
                    datasets.all.push(base + 2);
                    datasets.open.push(base + 1);
                    datasets.onHold.push(Math.floor(Math.random() * 2));
                    datasets.progress.push(Math.floor(Math.random() * 2));
                    datasets.closed.push(Math.floor(Math.random() * 3));
                    datasets.delayed.push(Math.floor(Math.random() * 1));
                    datasets.unassigned.push(Math.floor(Math.random() * 1));
                }

                // Use actual current totals for the last data point
                const currentStats = this.getTicketCounts();

                // Map counts to the last data point
                const lastIdx = 6;
                datasets.all[lastIdx] = currentStats['All Tickets'];
                datasets.open[lastIdx] = currentStats.Open;
                datasets.onHold[lastIdx] = currentStats['On Hold'];
                datasets.progress[lastIdx] = currentStats['On progress'];
                datasets.closed[lastIdx] = currentStats.Closed;
                datasets.delayed[lastIdx] = currentStats.Delayed;
                datasets.unassigned[lastIdx] = currentStats.Unassigned;

                this.state.adminChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'All Tickets', data: datasets.all, borderColor: '#1f2937', tension: 0.4, borderWidth: 2, fill: false },
                            { label: 'Open', data: datasets.open, borderColor: '#3b82f6', tension: 0.4, borderWidth: 2, fill: false },
                            { label: 'On Hold', data: datasets.onHold, borderColor: '#f59e0b', tension: 0.4, borderWidth: 2, fill: false },
                            { label: 'On Progress', data: datasets.progress, borderColor: '#10b981', tension: 0.4, borderWidth: 2, fill: false },
                            { label: 'Closed', data: datasets.closed, borderColor: '#8b5cf6', tension: 0.4, borderWidth: 2, fill: false },
                            { label: 'Delayed', data: datasets.delayed, borderColor: '#ef4444', tension: 0.4, borderWidth: 2, fill: false },
                            { label: 'Unassigned', data: datasets.unassigned, borderColor: '#6b7280', borderDash: [5, 5], tension: 0.4, borderWidth: 2, fill: false }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } }
                        },
                        scales: {
                            y: { beginAtZero: true, grid: { display: true, drawBorder: false } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            },

            loadTicketDetail(ticketId) {
                this.state.selectedTicketId = ticketId;
                this.navigate('ticket-detail');
                this.renderTicketDetail();
            },

            // --- boilerplate methods (showToast, logHistory, createNotification, markNotificationsAsRead) ---
            showToast(message, isError = true) {
                document.querySelectorAll('.toast').forEach(t => t.remove());
                const toast = document.createElement('div');
                toast.className = 'toast';
                if (!isError) toast.style.backgroundColor = '#0d9488';
                toast.innerHTML = `<div class="flex items-center gap-2"><svg class="h-5 w-5 flex-shrink-0"><use href="${isError ? '#icon-alert-triangle' : '#icon-check-circle'}"></use></svg><span class="font-medium">${message}</span></div>`;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.classList.add('fade-out');
                    toast.addEventListener('animationend', () => { if (document.body.contains(toast)) document.body.removeChild(toast); });
                }, 3000);
            },
            logHistory(ticketId, userId, action) {
                const ticket = this.state.tickets.find(t => t.id === ticketId);
                const user = this.getUser(userId);
                if (ticket) {
                    ticket.history.push({ userId: userId, userName: user.name, action: action, timestamp: new Date().toISOString() });
                }
            },
            createNotification(userId, text) {
                this.state.notifications.unshift({ id: `n-${Date.now()}`, userId, text, timestamp: new Date().toISOString(), read: false });
                this.renderHeader();
            },
            markNotificationsAsRead() {
                this.state.notifications.filter(n => n.userId === this.state.currentUser.id).forEach(n => n.read = true);
                this.renderHeader();
            },

            // --- NAVIGATION & RENDERING ---
            navigate(viewName) {
                this.state.currentView = viewName;
                const authView = document.getElementById('auth-view');
                const mainAppView = document.getElementById('main-app-view');
                const adminDashboardView = document.getElementById('admin-dashboard-view');
                
                // Reset all views
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.querySelectorAll('.auth-card').forEach(v => v.classList.remove('active'));
                document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));

                if (viewName.startsWith('auth-')) {
                    authView.classList.add('active');
                    document.getElementById(viewName.replace('auth-', '') + '-view').classList.add('active');
                } else if (viewName === 'admin-dashboard') {
                    adminDashboardView.classList.add('active');
                    // Ensure the main app content is hidden
                    mainAppView.classList.remove('active');
                } else {
                    mainAppView.classList.add('active');
                    document.getElementById(viewName + '-view').classList.add('active');
                    // Ensure the admin dashboard content is hidden
                    adminDashboardView.classList.remove('active');
                }
                window.scrollTo(0, 0);
                
                // Cleanup
                if (viewName !== 'ticket-detail') {
                    this.state.activeTicketTab = 'conversation';
                    this.state.quillInstance = null;
                }
                if (!['project-detail', 'ticket-detail', 'new-ticket', 'new-project'].includes(viewName)) {
                    this.state.selectedProjectId = null;
                }
                if (viewName !== 'ticket-detail') {
                    this.state.selectedTicketId = null;
                }
            },

            render() {
                if (!this.state.currentUser) { this.navigate('auth-login'); this.renderHeader(); return; }
                this.renderHeader();
                
                switch(this.state.currentView) {
                    case 'admin-dashboard': this.renderAdminDashboard(); break;
                    case 'dashboard': this.renderDashboard(); break;
                    case 'new-project': this.renderNewProjectForm(); break;
                    case 'project-detail': this.renderProjectDetail(); break;
                    case 'ticket-detail': this.renderTicketDetail(); break;
                    case 'new-ticket': this.renderNewTicketForm(); break;
                    default: 
                        // Fallback Logic for Admin vs User default view
                        if(this.state.currentUser.role === 'Admin') {
                            this.navigate('admin-dashboard');
                            this.renderAdminDashboard();
                        } else {
                            this.navigate('dashboard');
                            this.renderDashboard();
                        }
                }
            },
            
            // ... renderHeader, renderDashboard, renderProjectDetail ...
            // (These are largely unchanged but included for completeness)
            renderHeader() {
                const navRight = document.getElementById('nav-right-side');
                const navTitle = document.getElementById('nav-title');
                if (!this.state.currentUser) { navRight.innerHTML = ''; navTitle.innerText = 'Workflow Help Desk'; return; }
                
                let titleText = 'Workflow Help Desk';
                if (this.state.currentUser.role === 'Admin') { titleText += ' | Admin'; }
                navTitle.innerText = titleText;
                
                const myNotifications = this.state.notifications.filter(n => n.userId === this.state.currentUser.id);
                const unreadCount = myNotifications.filter(n => !n.read).length;
                navRight.innerHTML = `
                    <button id="live-chat-button" class="flex items-center text-sm font-medium text-gray-600 hover:text-teal-600 mr-2">
                        <svg class="h-5 w-5 mr-1"><use href="#icon-chat"></use></svg> Live Chat
                    </button>
                    <div class="relative">
                        <button id="notification-button" type="button" class="relative p-2 rounded-full text-gray-600 hover:bg-gray-100 focus:outline-none">
                                <svg class="h-6 w-6"><use href="#icon-bell"></use></svg>
                                <span id="notification-dot" class="${unreadCount > 0 ? '' : 'hidden'} absolute top-1 right-1 h-2.5 w-2.5 bg-red-500 rounded-full border-2 border-white"></span>
                        </button>
                        <div id="notification-panel" class="hidden absolute right-0 mt-2 w-80 sm:w-96 bg-white rounded-lg shadow-xl border border-gray-200 z-50 overflow-hidden">
                            <div class="p-3 border-b border-gray-200"><h3 class="text-base font-semibold text-gray-900">Notifications</h3></div>
                            <div id="notification-list" class="max-h-96 overflow-y-auto comment-scrollbar">
                                ${myNotifications.length === 0 ? '<p class="text-sm text-gray-500 p-4 text-center">No notifications.</p>' : myNotifications.map(n => `
                                    <div class="p-4 border-b border-gray-100 hover:bg-gray-50 ${n.read ? 'opacity-70' : 'font-semibold'}">
                                        <p class="text-sm text-gray-800">${n.text}</p><p class="text-xs text-gray-500 mt-1">${this.timeAgo(n.timestamp)}</p>
                                    </div>`).join('')}
                            </div>
                            <div class="p-2 bg-gray-50 border-t border-gray-200"><button id="notification-clear" class="w-full text-center text-sm text-teal-600 hover:underline">Mark all as read</button></div>
                        </div>
                    </div>
                    <button id="logout-button" class="flex items-center text-sm font-medium text-gray-600 hover:text-teal-600">
                        <svg class="h-5 w-5 mr-1"><use href="#icon-log-out"></use></svg> Logout
                    </button>
                `;
                // Bind nav events
                document.getElementById('live-chat-button').onclick = () => this.showToast('Live Chat feature is not connected to a backend.', false);
                document.getElementById('notification-button').onclick = () => document.getElementById('notification-panel').classList.toggle('hidden');
                document.getElementById('notification-clear').onclick = () => { this.markNotificationsAsRead(); document.getElementById('notification-panel').classList.add('hidden'); };
                // NOTE: logout-button listener is defined in initListeners
            },

            renderDashboard() {
                const { currentUser, projects, tickets } = this.state;
                const dashboardView = document.getElementById('dashboard-view');
                
                let projectCardsHtml = '';
                if (projects.length === 0) {
                    projectCardsHtml = '<p class="text-gray-500 col-span-full text-center py-10">No projects have been created yet.</p>';
                } else {
                    projectCardsHtml = projects.map(p => {
                        const projectTickets = tickets.filter(t => t.projectId === p.id);
                        const openTickets = projectTickets.filter(t => t.status !== 'Closed' && t.status !== 'Cancelled').length;
                        const userIds = new Set();
                        projectTickets.forEach(t => {
                            if(t.createdByUserId) userIds.add(t.createdByUserId);
                            if(t.assignedToUserId) userIds.add(t.assignedToUserId);
                        });
                        const usersInProject = Array.from(userIds).map(id => this.getUser(id));
                        let avatarsHtml = '';
                        const maxAvatars = 4;
                        const displayUsers = usersInProject.slice(0, maxAvatars);
                        const extraCount = usersInProject.length - maxAvatars;
                        if(usersInProject.length === 0) {
                             avatarsHtml = '<span class="text-xs text-gray-400 italic">No active members</span>';
                        } else {
                            avatarsHtml = `<div class="avatar-group">` + 
                                displayUsers.map(u => 
                                    `<img src="https://placehold.co/24x24/e2e8f0/64748b?text=${u.name.charAt(0)}" title="${u.name}" class="h-6 w-6 rounded-full bg-gray-100 border-2 border-white">`
                                ).join('') + 
                                (extraCount > 0 ? `<div class="h-6 w-6 rounded-full bg-gray-100 border-2 border-white flex items-center justify-center text-[10px] font-medium text-gray-600">+${extraCount}</div>` : '') +
                                `</div>`;
                        }
                        const description = p.description || "No description available for this project.";
                        const typeBadgeColor = p.type === 'Internal' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800';
                        const typeLabel = p.type || 'External'; 
                        return `
                            <div class="bg-white rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition-all duration-200 flex flex-col h-full">
                                <div class="p-5 flex-grow">
                                    <div class="flex justify-between items-start mb-2">
                                        <h3 class="text-lg font-bold text-gray-900 line-clamp-1" title="${p.name}">${p.name}</h3>
                                        <div class="flex gap-2">
                                            <span class="text-[10px] uppercase font-bold px-2 py-1 rounded-full ${typeBadgeColor}">${typeLabel}</span>
                                            <span class="text-xs font-semibold px-2 py-1 rounded-full ${openTickets > 0 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'} whitespace-nowrap">${openTickets} Open</span>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-4 line-clamp-2 h-10">${description}</p>
                                    <div class="flex items-center justify-between mt-auto pt-4 border-t border-gray-100">
                                        <div class="flex flex-col">
                                            <span class="text-[10px] uppercase text-gray-400 font-semibold tracking-wide mb-1">Active Members</span>
                                            ${avatarsHtml}
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs text-gray-500">Total Tickets</div>
                                            <div class="font-semibold text-gray-900">${projectTickets.length}</div>
                                        </div>
                                    </div>
                                </div>
                                <a href="#" data-project-id="${p.id}" class="project-card block bg-gray-50 hover:bg-teal-50 border-t border-gray-200 p-3 text-center text-sm font-medium text-teal-600 transition-colors">
                                    View Project Details &rarr;
                                </a>
                            </div>
                        `;
                    }).join('');
                }
                
                const projectList = document.getElementById('project-list') || document.createElement('div');
                projectList.id = 'project-list';
                projectList.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                projectList.innerHTML = projectCardsHtml;
                
                dashboardView.innerHTML = `
                    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 id="dashboard-title" class="text-3xl font-bold text-gray-900">Projects</h2>
                            <button id="show-new-project-form" class="flex items-center justify-center h-10 px-4 py-2 bg-teal-600 text-white rounded-md text-sm font-medium hover:bg-teal-700 focus:outline-none shadow-sm">
                                <svg class="h-5 w-5 mr-2 -ml-1"><use href="#icon-plus"></use></svg>
                                Create New Project
                            </button>
                        </div>
                        ${projectList.outerHTML}
                    </div>
                `;
            },
            
            // FIX: Re-insert full content HTML into renderProjectDetail
            renderProjectDetail() {
                const { currentUser, selectedProjectId } = this.state;
                const project = this.getProject(selectedProjectId);
                if (!project) {
                    this.showToast('Could not find project.');
                    this.navigate('dashboard');
                    return;
                }
                document.getElementById('project-detail-title').innerText = project.name;
                
                this.state.currentFilter = 'all';
                this.state.searchTerm = '';
                this.state.currentTheme = project.type === 'External' ? 'teal' : 'purple';
                const theme = this.state.currentTheme;
                const themeBg = `bg-${theme}-50`;
                const themeText = `text-${theme}-800`;
                const themeBtn = `bg-${theme}-600 hover:bg-${theme}-700`;
                
                const filters = [
                    { key: 'all', label: 'All Tickets' },
                    { key: 'open', label: 'Open' },
                    { key: 'unassigned', label: 'Unassigned' },
                    { key: 'onhold', label: 'On Hold' },
                    { key: 'progress', label: 'On Progress' },
                    { key: 'closed', label: 'Closed' },
                    { key: 'delayed', label: 'Delayed' },
                    { key: 'sla', label: 'SLA' }
                ];
                const filterNav = filters.map(f => `
                    <button data-filter="${f.key}" class="w-full text-left px-3 py-2 rounded-md text-sm font-medium ${f.key === this.state.currentFilter ? `${themeBg} ${themeText} font-semibold` : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'} transition-colors">
                        ${f.label}
                    </button>
                `).join('');
                
                const content = document.getElementById('project-ticket-lists');
                
                // IMPORTANT FIX: Re-generate the inner HTML structure
                content.innerHTML = `
                    <div class="flex gap-2 h-full">
                        <aside class="w-64 flex-shrink-0">
                            <div class="bg-white rounded-xl shadow-lg border p-6 h-full">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Ticket Filters</h3>
                                <nav class="space-y-1">${filterNav}</nav>
                            </div>
                        </aside>
                        <main class="flex-1">
                            <div class="bg-white rounded-xl shadow-lg border p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 id="table-title" class="text-lg font-semibold text-gray-900">${this.getFilterTitle(this.state.currentFilter)}</h3>
                                    <input id="ticket-search" type="text" placeholder="Search tickets..." class="h-10 px-4 rounded-md border border-gray-300 focus:border-${theme}-500 focus:ring-1 focus:ring-${theme}-500">
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full table-auto">
                                        <thead>
                                            <tr class="${themeBg}">
                                                <th class="px-4 py-3 text-left text-xs font-medium ${themeText} uppercase tracking-wider">Ticket ID</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium ${themeText} uppercase tracking-wider">Title</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium ${themeText} uppercase tracking-wider">User</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium ${themeText} uppercase tracking-wider">Assigned</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium ${themeText} uppercase tracking-wider">Priority</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium ${themeText} uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium ${themeText} uppercase tracking-wider">Created</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium ${themeText} uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ticket-table-body" class="divide-y divide-gray-200">
                                        </tbody>
                                    </table>
                                </div>
                                <div id="no-tickets" class="hidden text-center py-8 text-gray-500">
                                    <svg class="h-12 w-12 mx-auto mb-2"><use href="#icon-inbox"></use></svg>
                                    No tickets found.
                                </div>
                            </div>
                        </main>
                    </div>
                `;
                
                // Render initial table
                this.renderProjectTicketTable();
                
                // Set up search debounce
                const searchInput = document.getElementById('ticket-search');
                const debouncedSearch = this.debounce((e) => {
                    this.state.searchTerm = e.target.value;
                    this.renderProjectTicketTable();
                }, 300);
                if (searchInput) {
                    searchInput.oninput = debouncedSearch;
                }
                
                // Update create button theme
                const createBtn = document.getElementById('show-new-ticket-form');
                if (createBtn) {
                    createBtn.className = createBtn.className.replace(/bg-(teal|purple)-\d+ hover:bg-(teal|purple)-\d+/g, `${themeBtn}`);
                }
            },
            renderTicketDetail() {
                const ticket = this.state.tickets.find(t => t.id === this.state.selectedTicketId);
                if (!ticket) return this.navigate('dashboard');
                const isOverdue = ticket.dueDate && new Date(ticket.dueDate) < new Date() && t.status !== 'Closed';
                document.getElementById('ticket-detail-header').innerHTML = `
                    <div class="flex justify-between items-start">
                        <h2 class="text-2xl font-bold text-gray-900">${ticket.subject}</h2>
                        <span class="text-sm font-semibold px-3 py-1 rounded-full ${this.getStatusBadge(ticket.status).match(/class="([^"]+)"/)[1]} flex-shrink-0 ml-4">${ticket.status}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">ID: <span class="font-medium">${ticket.id}</span></p>
                `;
                document.getElementById('ticket-detail-sidebar').innerHTML = `
                    ${this.buildWorkflowActions(ticket)}
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Details</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between"><span class="text-gray-600">Priority:</span><span class="font-semibold px-2.5 py-0.5 rounded-full ${this.getPriorityBadge(ticket.priority).match(/class="([^"]+)"/)[1]}">${ticket.priority}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Due Date:</span><span class="font-medium ${isOverdue ? 'text-red-600' : 'text-gray-900'}">${this.formatDate(ticket.dueDate)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Project:</span><span class="font-medium text-gray-900">${this.getProject(ticket.projectId).name}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Created By:</span><span class="font-medium text-gray-900">${this.getUser(ticket.createdByUserId).name}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Assigned To:</span><span class="font-medium text-gray-900">${this.getUser(ticket.assignedToUserId).name}</span></div>
                        </div>
                    </div>
                `;
                this.renderTicketTabs(ticket);
            },
             renderTicketTabs(ticket) {
                const activeTab = this.state.activeTicketTab;
                const tabs = [
                    { id: 'conversation', label: 'Conversation', icon: 'icon-message-square' },
                    { id: 'resolution', label: 'Resolution', icon: 'icon-check-square' },
                    { id: 'timeentry', label: 'Time Entry', icon: 'icon-clock' },
                    { id: 'attachments', label: 'Attachments', icon: 'icon-paperclip' },
                    { id: 'approval', label: 'Approval', icon: 'icon-thumbs-up' },
                    { id: 'history', label: 'History', icon: 'icon-history' },
                ];
                document.getElementById('ticket-tab-nav').innerHTML = tabs.map(tab => `
                    <button data-tab="${tab.id}" class="ticket-tab-button flex items-center gap-2 px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 ${tab.id === activeTab ? 'active' : ''}">
                        <svg class="h-4 w-4"><use href="#${tab.icon}"></use></svg>${tab.label}
                    </button>
                `).join('');
                
                this.state.quillInstance = null;

                let tabContentHtml = '';
                if (activeTab === 'conversation') {
                    tabContentHtml = `
                        <div id="comment-list" class="space-y-4 max-h-96 overflow-y-auto comment-scrollbar p-1">${this.buildCommentList(ticket.comments)}</div>
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <div id="comment-toolbar">
                                <span class="ql-formats">
                                    <button class="ql-bold"></button>
                                    <button class="ql-italic"></button>
                                    <button class="ql-underline"></button>
                                    <button class="ql-strike"></button>
                                </span>
                                <span class="ql-formats">
                                    <button class="ql-list" value="ordered"></button>
                                    <button class="ql-list" value="bullet"></button>
                                </span>
                                <span class="ql-formats">
                                    <button class="ql-link"></button>
                                    <button class="ql-image"></button>
                                    <button class="ql-clean"></button>
                                </span>
                            </div>
                            <div id="comment-editor"></div>
                            
                            <div class="flex justify-between items-center mt-3">
                                <div>
                                        <label for="file-upload" class="format-button p-2 rounded hover:bg-gray-100 cursor-pointer inline-block" title="Attach File (demo)">
                                            <svg class="h-5 w-5 text-gray-600"><use href="#icon-paperclip"></use></svg>
                                        </label>
                                        <input type="file" id="file-upload" multiple class="hidden">
                                </div>
                                <button id="submit-comment-btn" class="h-10 px-4 py-2 flex-shrink-0 flex items-center justify-center bg-teal-600 text-white rounded-md hover:bg-teal-700 shadow-sm text-sm font-medium">
                                        Comment
                                </button>
                            </div>
                            <div id="attachment-previews" class="px-1 pt-3 text-sm"></div>
                        </div>`;
                } else if (activeTab === 'resolution') {
                    tabContentHtml = this.buildResolutionTab(ticket);
                } else if (activeTab === 'timeentry') {
                    tabContentHtml = this.buildTimeEntryTab(ticket);
                } else if (activeTab === 'history') {
                    tabContentHtml = `<div id="history-list" class="space-y-4 max-h-96 overflow-y-auto comment-scrollbar p-1">${this.buildHistoryList(ticket.history)}</div>`;
                } else {
                    tabContentHtml = `<div class="p-8 text-center rounded-md border-2 border-dashed border-gray-300"><h4 class="mt-2 text-lg font-medium text-gray-900">Backend Required</h4><p class="text-sm text-gray-500 mt-1">This feature (${activeTab}) requires a database connection.</p></div>`;
                }
                document.getElementById('ticket-tab-content').innerHTML = tabContentHtml;
                if (activeTab === 'conversation') {
                    this.initializeQuill();
                }
            },
            initializeQuill() {
                if (typeof Quill === 'undefined') return;
                if (document.getElementById('comment-editor') && !this.state.quillInstance) {
                    const quill = new Quill('#comment-editor', {
                        modules: {
                            toolbar: {
                                container: '#comment-toolbar',
                                handlers: {
                                    'link': () => this.handleQuillLink(),
                                    'image': () => this.handleQuillImage()
                                }
                            }
                        },
                        placeholder: 'Add a comment...',
                        theme: 'snow'
                    });
                    this.state.quillInstance = quill;
                }
            },
             handleQuillLink() {
                const quill = this.state.quillInstance;
                if (!quill) return;
                const range = quill.getSelection(true); 
                const text = quill.getText(range.index, range.length);
                this.state.quillSelection = range;
                document.getElementById('modal-link-text').value = text;
                document.getElementById('modal-link-url').value = '';
                document.getElementById('insert-link-modal').classList.remove('hidden');
                document.getElementById('modal-link-url').focus();
            },
            handleQuillImage() { this.showToast('Image uploads are not supported in this demo.', false); },
            buildCommentList(comments) {
                if (comments.length === 0) return '<p class="text-sm text-gray-500 text-center">No comments yet.</p>';
                return comments.map(c => {
                    const user = this.getUser(c.userId);
                    const commentHTML = c.isHtml ? c.text : `<p>${c.text.replace(/\n/g, '<br>')}</p>`;
                    return `<div class="flex items-start gap-3">
                        <img src="https://placehold.co/40x40/e2e8f0/64748b?text=${user.name.charAt(0)}" alt="${user.name}" class="h-10 w-10 rounded-full flex-shrink-0">
                        <div class="flex-grow bg-gray-100 p-3 rounded-lg"><div class="flex justify-between"><span class="font-semibold text-sm text-gray-800">${user.name}</span><span class="text-xs text-gray-500">${this.timeAgo(c.timestamp)}</span></div>
                        <div class="text-sm text-gray-700 mt-1 ql-snow" style="border:none;">
                            <div class="ql-editor static-content">${commentHTML}</div>
                        </div>
                        </div>
                    </div>`
                }).join('');
            },
            buildHistoryList(history) {
                if (!history) return '<p class="text-sm text-gray-500 text-center">No history.</p>';
                const populatedHistory = history.map(h => ({ ...h, userName: h.userName || this.getUser(h.userId).name }));
                return [...populatedHistory].reverse().map(h => `<div class="flex items-center gap-3">
                    <img src="https://placehold.co/32x32/e2e8f0/64748b?text=${h.userName ? h.userName.charAt(0) : '?'}" alt="${h.userName}" class="h-8 w-8 rounded-full flex-shrink-0">
                    <div class="flex-grow"><p class="text-sm"><span class="font-semibold text-gray-800">${h.userName || 'System'}</span> <span class="text-gray-600">${h.action}</span></p><p class="text-xs text-gray-500">${this.timeAgo(h.timestamp)}</p></div>
                </div>`).join('<hr class="my-3">');
            },
            buildResolutionTab(ticket) {
                if (ticket.status === 'Closed' && ticket.resolution) return `<h3 class="text-lg font-semibold mb-3">Final Resolution</h3><div class="bg-gray-50 p-4 rounded-md border border-gray-200"><p class="text-gray-700 whitespace-pre-wrap">${ticket.resolution}</p></div>`;
                if (ticket.status === 'Closed') return '<p class="text-center text-gray-500">This ticket was closed without a formal resolution.</p>';
                if (this.state.currentUser.id !== ticket.assignedToUserId && this.state.currentUser.role !== 'Admin') return '<p class="text-center text-gray-500">Awaiting resolution from the assigned agent.</p>';
                return `<form id="resolution-form"><label class="block text-sm font-medium text-gray-700 mb-1">Add Resolution & Close Ticket</label><textarea id="resolution-text" rows="5" class="w-full rounded-md border border-gray-300 p-2 mb-3" required></textarea><button type="submit" class="h-10 px-4 bg-green-600 text-white rounded-md text-sm font-medium">Save Resolution & Close</button></form>`;
            },
            buildTimeEntryTab(ticket) {
                const list = ticket.timeEntries.length ? ticket.timeEntries.map(e => `<div class="p-3 bg-gray-50 rounded-lg border border-gray-200"><div class="flex justify-between"><span class="font-semibold text-sm">${this.getUser(e.userId).name} logged ${e.hours}h</span><span class="text-xs text-gray-500">${this.formatDate(e.date)}</span></div><p class="text-sm text-gray-700">${e.description}</p></div>`).join('<div class="my-3"></div>') : '<p class="text-center text-gray-500">No time logged.</p>';
                const form = (this.state.currentUser.role === 'Admin' || this.state.currentUser.id === ticket.assignedToUserId) ? `<div class="mt-6 pt-6 border-t border-gray-200"><h3 class="text-lg font-semibold text-gray-800 mb-3">Log Time</h3><form id="time-entry-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="text-sm">Hours</label><input type="number" id="time-entry-hours" step="0.1" min="0.1" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" required></div><div><label class="text-sm">Date</label><input type="date" id="time-entry-date" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" value="${new Date().toISOString().split('T')[0]}" required></div></div><div><label class="text-sm">Description</label><input type="text" id="time-entry-description" class="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" required></div><div class="text-right"><button type="submit" class="h-10 px-4 py-2 bg-teal-600 text-white rounded-md text-sm font-medium">Log Time</button></div></form></div>` : '';
                return `<h3 class="text-lg font-semibold text-gray-800 mb-4">Time Log</h3><div class="space-y-3 max-h-60 overflow-y-auto comment-scrollbar p-1">${list}</div>${form}`;
            },
            buildWorkflowActions(ticket) {
                const { currentUser } = this.state;
                let html = '';
                if (currentUser.role === 'Admin' && ['New', 'Re-opened'].includes(ticket.status)) {
                    const options = this.state.users.filter(u => u.role !== 'User').map(u => `<option value="${u.id}">${u.name} (${u.role})</option>`).join('');
                    html = `<label class="block text-sm font-medium">Assign Ticket</label><div class="flex gap-2"><select id="assign-user" class="flex-grow h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm"><option value="">Select a user...</option>${options}</select><button id="assign-user-button" class="h-10 px-4 py-2 bg-teal-600 text-white rounded-md text-sm font-medium">Assign</button></div>`;
                }
                if (currentUser.id === ticket.assignedToUserId) {
                    if (['Assigned', 'Re-opened', 'On Hold'].includes(ticket.status)) html += `<button data-status="In Progress" class="workflow-action-button w-full h-10 px-4 py-2 bg-yellow-500 text-white rounded-md text-sm font-medium">Start/Resume Work</button>`;
                    if (ticket.status === 'In Progress') html += `<button data-status="On Hold" class="workflow-action-button w-full h-10 px-4 py-2 bg-gray-500 text-white rounded-md text-sm font-medium mt-2">Put On Hold</button>`;
                }
                if (html === '') html = '<p class="text-sm text-gray-500 text-center">No actions available.</p>';
                return `<div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200"><h3 class="text-lg font-semibold text-gray-800 mb-4">Workflow Actions</h3><div class="space-y-3">${html}</div></div>`;
            },
            renderNewProjectForm() { document.getElementById('new-project-form').reset(); },
            renderNewTicketForm() {
                const { currentUser, selectedProjectId } = this.state;
                const project = this.getProject(selectedProjectId);
                document.getElementById('new-ticket-form').reset();
                document.getElementById('new-ticket-name').value = currentUser.name;
                document.getElementById('new-ticket-email').value = currentUser.email;
                document.getElementById('new-ticket-project-wrapper').classList.remove('hidden');
                document.getElementById('new-ticket-project-name').value = project.name;
                document.getElementById('internal-ticket-toggle').classList.toggle('hidden', this.state.currentUser.role !== 'Admin');
                document.getElementById('new-ticket-due-date').min = new Date().toISOString().split('T')[0];
            },

            // --- HANDLERS ---
            onLogin(e) {
                if (e) e.preventDefault(); // Only prevent default if called by a form submit event
                
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const user = this.state.users.find(u => u.email === email && u.password === password);
                const errorEl = document.getElementById('login-error');
                if (user) {
                    this.state.currentUser = user;
                    // Logic for Admin Dashboard redirect
                    if (user.role === 'Admin') {
                        this.navigate('admin-dashboard');
                    } else {
                        this.navigate('dashboard');
                    }
                    this.render();
                    errorEl.classList.add('hidden');
                } else {
                    errorEl.innerText = 'Invalid email or password.';
                    errorEl.classList.remove('hidden');
                }
            },
            onLogout() {
                this.state.currentUser = null;
                this.navigate('auth-login');
                this.renderHeader();
            },
            // ... other handlers (onNewProjectSubmit, onNewTicketSubmit, onAddComment, etc)
            onNewProjectSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const projectName = form['new-project-name'].value;
                if (!projectName) { this.showToast('Project Name is required.'); return; }
                const newProject = { id: `p-${Date.now().toString().slice(-4)}`, name: projectName, type: form['new-project-type'].value, description: form['new-project-description'].value };
                this.state.projects.push(newProject);
                this.navigate('dashboard');
                this.renderDashboard();
            },
            onNewTicketSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const newTicket = {
                    id: `T-${Date.now().toString().slice(-4)}`, subject: form['new-ticket-subject'].value, projectId: this.state.selectedProjectId, createdByUserId: this.state.currentUser.id,
                    type: this.state.currentUser.role === 'Admin' && form['new-ticket-internal'].checked ? 'Internal' : 'External',
                    status: 'New', priority: form['new-ticket-priority'].value, description: form['new-ticket-description'].value,
                    assignedToUserId: null, createdAt: new Date().toISOString(), dueDate: form['new-ticket-due-date'].value || null, resolution: null, timeEntries: [], comments: [], history: []
                };
                const user = this.getUser(this.state.currentUser.id);
                newTicket.history.push({ userId: user.id, userName: user.name, action: 'created the ticket', timestamp: newTicket.createdAt });
                newTicket.comments.push({ userId: user.id, text: `<p>Ticket Created. Description: ${newTicket.description.substring(0, 50)}...</p>`, isHtml: true, timestamp: newTicket.createdAt });
                this.state.tickets.unshift(newTicket);
                this.navigate('project-detail');
                this.renderProjectDetail();
            },
            onAddComment() {
                const quill = this.state.quillInstance;
                if (!quill) return;
                const text = quill.root.innerHTML;
                if (quill.getLength() <= 1) { this.showToast("Cannot submit an empty comment."); return; }
                const t = this.state.tickets.find(t => t.id === this.state.selectedTicketId);
                if (!t) return;
                t.comments.push({ userId: this.state.currentUser.id, text: text, isHtml: true, timestamp: new Date().toISOString() });
                this.logHistory(t.id, this.state.currentUser.id, 'added a comment');
                document.getElementById('comment-list').innerHTML = this.buildCommentList(t.comments);
                document.getElementById('comment-list').scrollTop = document.getElementById('comment-list').scrollHeight;
                quill.setText('');
                document.getElementById('attachment-previews').innerHTML = '';
                document.getElementById('file-upload').value = null;
            },
            handleFileAttachment(event) {
                const files = event.target.files;
                if (!files || files.length === 0) return;
                const previewContainer = document.getElementById('attachment-previews');
                let fileListHtml = '<h4 class="font-semibold text-gray-700 mb-1">Attachments:</h4><ul class="list-disc pl-5">';
                for (const file of files) { fileListHtml += `<li class="text-gray-600">${file.name} <span class="text-gray-400">(${(file.size / 1024).toFixed(1)} KB)</span></li>`; }
                fileListHtml += '</ul>';
                previewContainer.innerHTML = fileListHtml;
            },
            
            initListeners() {
                // Auth & Global
                document.getElementById('login-form').onsubmit = (e) => this.onLogin(e);
                document.querySelectorAll('.demo-login-button').forEach(b => b.onclick = () => {
                    document.getElementById('login-email').value = b.dataset.email;
                    document.getElementById('login-password').value = b.dataset.password;
                    document.getElementById('login-form').dispatchEvent(new Event('submit'));
                });
                
                // Auth Navigation
                ['show-signup-form', 'show-forgot-form', 'show-login-form-from-signup', 'show-login-form-from-forgot'].forEach(id => {
                    document.getElementById(id).onclick = (e) => { e.preventDefault(); this.navigate(e.target.id.includes('signup') ? 'auth-signup' : e.target.id.includes('forgot') ? 'auth-forgot-password' : 'auth-login'); };
                });
                document.getElementById('signup-form').onsubmit = (e) => { e.preventDefault(); this.showToast('Signup is disabled in this demo.', false); };
                document.getElementById('forgot-form').onsubmit = (e) => { e.preventDefault(); this.showToast('Reset link sent (simulation).', false); document.getElementById('forgot-success').classList.remove('hidden'); document.getElementById('forgot-success').innerText = 'Reset link sent (simulation).'; };

                // Standard App Navigation
                document.getElementById('back-to-projects').onclick = () => this.navigate('dashboard');
                document.getElementById('back-to-project-detail').onclick = () => this.navigate('project-detail');
                ['cancel-new-project', 'cancel-new-project-form'].forEach(id => document.getElementById(id).onclick = () => this.navigate('dashboard'));
                ['cancel-new-ticket', 'cancel-new-ticket-form'].forEach(id => document.getElementById(id).onclick = () => this.navigate('project-detail'));
                
                // Admin Dashboard Specific Nav
                document.getElementById('admin-nav-projects').onclick = () => this.navigate('dashboard');
                document.getElementById('admin-nav-dashboard').onclick = () => { this.navigate('admin-dashboard'); this.renderAdminDashboard(); };
                document.getElementById('admin-btn-project-details').onclick = () => this.navigate('dashboard');

                // Dynamic element listeners (must be attached to a parent)
                const mainViewsContainer = document.getElementById('main-app-view');
                const adminViewContainer = document.getElementById('admin-dashboard-view');

                const delegatedClickHandler = (e) => {
                     // Global Logout button listener
                    if (e.target.closest('#logout-button') || e.target.closest('#admin-logout')) {
                         this.onLogout();
                         return;
                    }

                     // Project card click
                     const projectCard = e.target.closest('.project-card');
                     if (projectCard) {
                         e.preventDefault();
                         this.state.selectedProjectId = projectCard.dataset.projectId;
                         this.navigate('project-detail');
                         this.renderProjectDetail();
                         return;
                     }

                     // Create ticket button
                     const createTicketBtn = e.target.closest('#show-new-ticket-form');
                     if (createTicketBtn) { this.navigate('new-ticket'); this.renderNewTicketForm(); return; }

                     // Ticket detail link
                     const detailLink = e.target.closest('a[data-ticket-id]');
                     if (detailLink) {
                         e.preventDefault();
                         this.state.selectedTicketId = detailLink.dataset.ticketId;
                         this.navigate('ticket-detail');
                         this.renderTicketDetail();
                         return;
                     }

                     // Delete ticket button
                     const delBtn = e.target.closest('button[data-delete-ticket]');
                     if (delBtn) {
                         if (!confirm('Are you sure you want to delete this ticket?')) return;
                         const tid = delBtn.dataset.deleteTicket;
                         this.state.tickets = this.state.tickets.filter(t => t.id !== tid);
                         this.showToast('Ticket deleted successfully.', false);
                         this.renderProjectTicketTable();
                         return;
                     }

                     // Filter button
                     const filterBtn = e.target.closest('button[data-filter]');
                     if (filterBtn && this.state.currentView === 'project-detail') {
                         e.preventDefault();
                         const theme = this.state.currentTheme;
                         document.querySelectorAll('button[data-filter]').forEach(b => b.classList.remove(`bg-${theme}-50`, `text-${theme}-700`, 'font-semibold'));
                         filterBtn.classList.add(`bg-${theme}-50`, `text-${theme}-700`, 'font-semibold');
                         this.state.currentFilter = filterBtn.dataset.filter;
                         document.getElementById('table-title').innerText = this.getFilterTitle(this.state.currentFilter);
                         this.state.searchTerm = '';
                         const searchInput = document.getElementById('ticket-search');
                         if (searchInput) searchInput.value = '';
                         this.renderProjectTicketTable();
                         return;
                     }

                     // Ticket tab button
                     const tabBtn = e.target.closest('.ticket-tab-button');
                     if (tabBtn) { e.preventDefault(); this.state.activeTicketTab = tabBtn.dataset.tab; this.renderTicketTabs(this.state.tickets.find(t => t.id === this.state.selectedTicketId)); return; }

                     // Assign user button
                     const assignBtn = e.target.closest('#assign-user-button');
                     if (assignBtn) {
                         const uid = document.getElementById('assign-user').value;
                         if (!uid) return this.showToast('Please select a user to assign.');
                         const t = this.state.tickets.find(t => t.id === this.state.selectedTicketId);
                         t.status = 'Assigned'; t.assignedToUserId = uid;
                         this.logHistory(t.id, this.state.currentUser.id, `assigned to ${this.getUser(uid).name}`);
                         this.createNotification(uid, `Ticket ${t.id} has been assigned to you.`);
                         this.state.quillInstance = null;
                         this.renderTicketDetail(); return;
                     }

                     // Workflow action button
                     const workflowBtn = e.target.closest('.workflow-action-button');
                     if (workflowBtn) {
                         const t = this.state.tickets.find(t => t.id === this.state.selectedTicketId);
                         t.status = workflowBtn.dataset.status;
                         this.logHistory(t.id, this.state.currentUser.id, `changed status to ${t.status}`);
                         this.state.quillInstance = null;
                         this.renderTicketDetail(); return;
                     }

                     // Submit comment button
                     const submitCommentBtn = e.target.closest('#submit-comment-btn');
                     if (submitCommentBtn) { this.onAddComment(); return; }

                     // Create project button
                     const createProjectBtn = e.target.closest('#show-new-project-form');
                     if (createProjectBtn) { this.navigate('new-project'); this.renderNewProjectForm(); return; }
                };

                mainViewsContainer.addEventListener('click', delegatedClickHandler);
                adminViewContainer.addEventListener('click', delegatedClickHandler);

                const delegatedSubmitHandler = (e) => {
                    e.preventDefault();
                    if (e.target.id === 'new-project-form') { this.onNewProjectSubmit(e); return; }
                    if (e.target.id === 'new-ticket-form') { this.onNewTicketSubmit(e); return; }
                    const t = this.state.tickets.find(t => t.id === this.state.selectedTicketId);
                    if (!t) return;
                    if (e.target.id === 'resolution-form') {
                        t.resolution = document.getElementById('resolution-text').value;
                        t.status = 'Closed';
                        this.logHistory(t.id, this.state.currentUser.id, 'added resolution and closed ticket');
                        this.state.quillInstance = null;
                        this.renderTicketDetail();
                    }
                    if (e.target.id === 'time-entry-form') {
                        const hours = document.getElementById('time-entry-hours').value;
                        t.timeEntries.push({ userId: this.state.currentUser.id, hours: hours, date: document.getElementById('time-entry-date').value, description: document.getElementById('time-entry-description').value });
                        this.logHistory(t.id, this.state.currentUser.id, `logged ${hours} hours`);
                        this.renderTicketTabs(t);
                    }
                };

                mainViewsContainer.addEventListener('submit', delegatedSubmitHandler);
                adminViewContainer.addEventListener('submit', delegatedSubmitHandler);
                
                mainViewsContainer.addEventListener('change', (e) => { if (e.target.id === 'file-upload') { this.handleFileAttachment(e); } });
                
                // Modal
                const modal = document.getElementById('insert-link-modal');
                document.getElementById('modal-close-btn').onclick = () => modal.classList.add('hidden');
                document.getElementById('modal-cancel-btn').onclick = () => modal.classList.add('hidden');
                document.getElementById('modal-insert-btn').onclick = () => {
                    const text = document.getElementById('modal-link-text').value;
                    const url = document.getElementById('modal-link-url').value;
                    if (!url) { this.showToast('Please enter a URL.'); return; }
                    const quill = this.state.quillInstance;
                    const range = this.state.quillSelection;
                    if (quill && range) {
                        quill.deleteText(range.index, range.length);
                        quill.insertText(range.index, text || url, 'link', url);
                        quill.setSelection(range.index + (text || url).length, 0);
                    }
                    modal.classList.add('hidden');
                };
            },
            start() {
                this.state.tickets.forEach(t => { if (!t.history) t.history = []; t.history.forEach(h => { if (h.userId && !h.userName) { h.userName = this.getUser(h.userId).name; } }); });
                this.initListeners();
                this.render();
            }
        };
        document.addEventListener('DOMContentLoaded', () => app.start());
    </script>
</body>
</html>